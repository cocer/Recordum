<!doctype html>
<html>

<head>
  <meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="description" content="All about Recordum" />
<link rel="stylesheet" href="/css/style.css" />

  <title>
关于 react-router 的 browserHistory 模式 - Recordum
</title>
</head>

<body>

<div class="main">

<div class="header">
    <a class="logo" href="/">Recordum</a><!--

 --><div class="menu">
        <a href="/archives/">Archives</a><a href="/about/">About</a>
    </div>

    <div class="social">
        <a target="_blank" href="https://github.com/LoeiFy/Recordum/issues"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<path d="M12,2A10,10 0 0,0 2,12C2,16.42 4.87,20.17 8.84,21.5C9.34,21.58 9.5,21.27 9.5,21C9.5,20.77 9.5,20.14 9.5,19.31C6.73,19.91 6.14,17.97 6.14,17.97C5.68,16.81 5.03,16.5 5.03,16.5C4.12,15.88 5.1,15.9 5.1,15.9C6.1,15.97 6.63,16.93 6.63,16.93C7.5,18.45 8.97,18 9.54,17.76C9.63,17.11 9.89,16.67 10.17,16.42C7.95,16.17 5.62,15.31 5.62,11.5C5.62,10.39 6,9.5 6.65,8.79C6.55,8.54 6.2,7.5 6.75,6.15C6.75,6.15 7.59,5.88 9.5,7.17C10.29,6.95 11.15,6.84 12,6.84C12.85,6.84 13.71,6.95 14.5,7.17C16.41,5.88 17.25,6.15 17.25,6.15C17.8,7.5 17.45,8.54 17.35,8.79C18,9.5 18.38,10.39 18.38,11.5C18.38,15.32 16.04,16.16 13.81,16.41C14.17,16.72 14.5,17.33 14.5,18.26C14.5,19.6 14.5,20.68 14.5,21C14.5,21.27 14.66,21.59 15.17,21.5C19.14,20.16 22,16.42 22,12A10,10 0 0,0 12,2Z"></path>
</svg></a><!--
    --><a target="_blank" href="/"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
<path d="M6.18,15.64A2.18,2.18 0 0,1 8.36,17.82C8.36,19 7.38,20 6.18,20C5,20 4,19 4,17.82A2.18,2.18 0 0,1 6.18,15.64M4,4.44A15.56,15.56 0 0,1 19.56,20H16.73A12.73,12.73 0 0,0 4,7.27V4.44M4,10.1A9.9,9.9 0 0,1 13.9,20H11.07A7.07,7.07 0 0,0 4,12.93V10.1Z"></path>
</svg></a>
        
    </div>
</div>


<div id="post" class="center">
  <p class="time">February 26, 2017</p>
  <h1 class="title">关于 react-router 的 browserHistory 模式</h1>
  <div class="content"><p>SPA 项目基本上都会用到路由 <code>router</code>。react 还有 vue 对应有其路由插件。 react-router 还有 vue-router 都有 hashHistory 和 browserHistory 模式。这里大概说一下两者区别</p>
<ul>
<li>hashHistory: 不需要服务器配置，在 URL 生成一个 hash 来跟踪状态，通常在测试环境使用，也可以作为发布环境使用</li>
<li>browserHistory: 需要服务器端做配置，路径是真实的URL，是 react-router 官方推荐首选</li>
</ul>
<p>大多数情况下，browserHistory 模式明显是优于 hashHistory 模式的，但 browserHistory 需要一定的配置</p>
<h2 id="配置browserhistory">配置 browserHistory</h2><p>可以看出，hashHistory 不需要什么配置，但 browserHistory 需要服务端支持，这里简单说一下两种方式做支持，其它方式基本上都是类似</p>
<h3 id="使用express">使用 express</h3>
      <div class="hljs javascript">
        <table>
          <tbody>
            <tr>
              <td class="line">
                <pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
</pre>
              </td>
              <td class="code"><pre>const app = express<span class="hljs-literal">()</span>
app.get(<span class="hljs-character">'*'</span>, <span class="hljs-keyword">function</span> (request, response){
  response.send<span class="hljs-constructor">File(<span class="hljs-params">path</span>.<span class="hljs-params">resolve</span>(<span class="hljs-params">__dirname</span>, '<span class="hljs-params">index</span>.<span class="hljs-params">html</span>')</span>)
})</pre></td>
            </tr>
          </tbody>
        </table>
      </div>
    <h3 id="使用nginx">使用 nginx</h3>
      <div class="hljs perl">
        <table>
          <tbody>
            <tr>
              <td class="line">
                <pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
</pre>
              </td>
              <td class="code"><pre>server {
  ...
  <span class="hljs-keyword">location</span> <span class="hljs-title">/ {
    try_files</span> $uri /index.html
  }
}</pre></td>
            </tr>
          </tbody>
        </table>
      </div>
    <p>这里说明一下为什么要这样设置，browserHistory 模式下，URL 是指向真实 URL 的资源路径，当通过真实 URL 访问网站的时候（首页），这个时候可以正常加载我们的网站资源，而用户在非首页下手动刷新网页时，由于路径是指向服务器的真实路径，但该路径下并没有相关资源，用户访问的资源不存在，返回给用户的是 404 错误</p>
<p>通过上面所说的原理，简单起来说就是 browserHistory 模式下，需要每个路由下都要有对应的资源存在，就不会产生 404 错误，所以如果不借助服务端的话，又要实现这种模式，这种场景在自己不能配置服务器时候会碰到，例如把项目部署到 <code>GitHub pages</code> 上。那该怎么办呢</p>
<blockquote>
<p>那么就产生 对应资源 </p>
</blockquote>
<p>所以，我们的做法就是在每个 <strong>路由路径</strong> 下，都放置一个跟首页一样的 <code>index.html</code></p>
<p>下面是做法，当然也是有各种方式的，都是可以类推的</p>
<p>假定我们有以下的路由设定，这里以 react-router 为例子</p>

      <div class="hljs javascript">
        <table>
          <tbody>
            <tr>
              <td class="line">
                <pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
<span>10</span>
<span>11</span>
<span>12</span>
</pre>
              </td>
              <td class="code"><pre>export default (
  <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"/"</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{App}</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">IndexRoute</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{HomePage}</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"contact-us"</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{ContactPage}</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"dashboard"</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">IndexRoute</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{Verify(Dashboard)}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"inbox"</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{Verify(Inbox)}</span> /&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"conversation"</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{Verify(ComposeMessage)}</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Route</span> <span class="hljs-attr">path</span>=<span class="hljs-string">"*"</span> <span class="hljs-attr">component</span>=<span class="hljs-string">{NotFound}</span> /&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Route</span>&gt;</span>
)</pre></td>
            </tr>
          </tbody>
        </table>
      </div>
    <p>那么就可以路由路径为</p>

      <div class="hljs javascript">
        <table>
          <tbody>
            <tr>
              <td class="line">
                <pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
<span>8</span>
<span>9</span>
</pre>
              </td>
              <td class="code"><pre><span class="hljs-comment">// routes.js</span>
<span class="hljs-keyword">const</span> routes = [
  <span class="hljs-string">'contact-us'</span>,
  <span class="hljs-string">'dashboard'</span>,
  <span class="hljs-string">'dashborad/inbox'</span>,
  <span class="hljs-string">'dashboard/conversation'</span>
]

<span class="hljs-keyword">module</span>.<span class="hljs-keyword">exports</span> = routes</pre></td>
            </tr>
          </tbody>
        </table>
      </div>
    <p>接下来我们就把生成的 <code>index.html</code> 复制到这几个路径下就可以了</p>

      <div class="hljs javascript">
        <table>
          <tbody>
            <tr>
              <td class="line">
                <pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
<span>6</span>
<span>7</span>
</pre>
              </td>
              <td class="code"><pre><span class="hljs-comment">// deploy.js</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs-extra'</span>)
<span class="hljs-keyword">const</span> routes = <span class="hljs-built_in">require</span>(<span class="hljs-string">'routes.js'</span>)
<span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
routes.forEach(<span class="hljs-function">(<span class="hljs-params">route</span>) =&gt;</span> {
  fs.copySync(<span class="hljs-string">'index.html'</span>, path.join(route, <span class="hljs-string">'index.html'</span>))
})</pre></td>
            </tr>
          </tbody>
        </table>
      </div>
    <p>这样用户访问就不会出现 404 了，SPA 的功能也不受影响，为了方便我们可以把这个生成工具集成到 <code>package.json</code></p>

      <div class="hljs json">
        <table>
          <tbody>
            <tr>
              <td class="line">
                <pre><span>1</span>
<span>2</span>
<span>3</span>
<span>4</span>
<span>5</span>
</pre>
              </td>
              <td class="code"><pre>{
  <span class="hljs-attr">"script"</span>: {
    <span class="hljs-attr">"build"</span>: <span class="hljs-string">"NODE_ENV=production webpack --progress &amp;&amp; node deploy.js"</span>
  }
}</pre></td>
            </tr>
          </tbody>
        </table>
      </div>
    <p>ok, 当我们运行 <code>npm run build</code> 时候，就会同时生成对应路径下的 <code>index.html</code>，这样就可以了完成我们所需要的功能了</p>
<h2 id="问题思考">问题 &amp; 思考</h2><p>看到这里，应该会有一个疑问，如果 routes 中有一些是不能穷举的路径要怎么办？例如 <code>&lt;Route path=&quot;posts/:id&quot; component={Verify(Inbox)} /&gt;</code>。这时候是没办法生成对应资源的</p>
<p>不过还是可以使用以下 hack 方式：</p>
<p>直接使用服务端 404 页面了，如果是用 <code>GitHub pages</code> 的话，我们可以直接生成一个 <code>404.html</code> 即可，直接把 404 页面弄成跟 index 内容一样，404 时候就是正常的内容页面，这时候页面功能是正常的，并且不需要前面的一对做法了。</p>
</div>
  <div class="comments"><div id="disqus_thread"></div></div>
</div>


</div>

<div class="footer">
    <div class="center">
      Recordum / Powered by
      <a target="_blank" href="https://github.com/acyortjs/acyort">AcyOrt</a> /
      Theme
      <a target="_blank" href="https://github.com/acyortjs/theme-donob">donob</a>
    </div>
</div>







</body>
</html>
